#!/usr/bin/env bash
set -euo pipefail

src="out/triage-readonly.kubeconfig"
iface="wg0"
dst=""

usage() {
  cat <<EOF
Usage:
  $0 <dest-path> [--iface wg0] [--src out/triage-readonly.kubeconfig]

Quick hack: rewrites the kubeconfig's cluster server host to the IPv4 on a WireGuard interface.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --iface) iface="${2:-}"; shift 2 ;;
    --src) src="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *)
      if [[ -z "$dst" ]]; then
        dst="$1"; shift 1
      else
        echo "Unknown arg: $1" >&2
        usage
        exit 2
      fi
      ;;
  esac
done

if [[ -z "$dst" ]]; then
  usage
  exit 2
fi
if [[ ! -f "$src" ]]; then
  echo "Source kubeconfig not found: $src" >&2
  exit 1
fi
if ! command -v ip >/dev/null 2>&1; then
  echo "'ip' command not found (need iproute2)" >&2
  exit 1
fi

ip_out="$(ip -4 addr show dev "$iface" 2>&1 || true)"
if [[ "$ip_out" == *"Cannot open netlink socket"* ]]; then
  echo "Failed to read interface addresses via 'ip' (permission issue): $ip_out" >&2
  exit 1
fi

wg_ip="$(printf '%s\n' "$ip_out" | awk '$1=="inet"{print $2; exit}' | cut -d/ -f1)"
if [[ -z "$wg_ip" ]]; then
  echo "No IPv4 found on interface '$iface' (is it up?)" >&2
  echo "ip output:" >&2
  printf '%s\n' "$ip_out" >&2
  exit 1
fi

tmp="$(mktemp -t triage-wg-kubeconfig.XXXXXX)"
trap 'rm -f "$tmp"' EXIT

# Replace only the host part of: server: https://HOST:PORT (or http://HOST:PORT)
sed -E "s#^(\\s*server:\\s*https?://)[^:/]+#\\1${wg_ip}#g" "$src" >"$tmp"

mkdir -p "$(dirname "$dst")"
cp -f "$tmp" "$dst"
chmod 600 "$dst" 2>/dev/null || true

echo "wrote: $dst"
echo "server rewritten to: $wg_ip (from iface $iface)"

#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  ./triage-creds-info --kubeconfig <path>

Prints the effective token lifetime embedded in a kubeconfig (JWT `iat`/`exp` claims).

Notes:
  - This is the real validity period for kubeconfigs generated by ./triage-creds-up, because they
    contain a TokenRequest bearer token.
  - The requested duration (e.g. 24h) can be shortened by apiserver policy; this script shows what
    was actually issued.
EOF
}

kubeconfig=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --kubeconfig) kubeconfig="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

if [[ -z "$kubeconfig" ]]; then
  echo "Missing --kubeconfig <path>" >&2
  usage
  exit 2
fi
if [[ ! -f "$kubeconfig" ]]; then
  echo "Kubeconfig not found: $kubeconfig" >&2
  exit 1
fi

if command -v rg >/dev/null 2>&1; then
  token="$(rg -n --no-line-number -m1 '^[[:space:]]*token:[[:space:]]*' "$kubeconfig" | sed -E 's/^[[:space:]]*token:[[:space:]]*//')"
else
  token="$(grep -E -m1 '^[[:space:]]*token:[[:space:]]*' "$kubeconfig" | sed -E 's/^[[:space:]]*token:[[:space:]]*//')"
fi
if [[ -z "$token" ]]; then
  echo "No 'token:' field found in kubeconfig: $kubeconfig" >&2
  exit 1
fi

if command -v python3 >/dev/null 2>&1; then
  python3 - "$kubeconfig" "$token" <<'PY'
import base64
import json
import sys
from datetime import datetime, timezone

kubeconfig = sys.argv[1]
token = sys.argv[2]

parts = token.split(".")
if len(parts) < 2:
    raise SystemExit("Token is not a JWT; cannot determine expiration.")

payload = parts[1]
payload += "=" * ((4 - (len(payload) % 4)) % 4)
payload = payload.replace("-", "+").replace("_", "/")

data = json.loads(base64.b64decode(payload))
iat = int(data.get("iat"))
exp = int(data.get("exp"))
ttl = exp - iat
if ttl < 0:
    raise SystemExit("JWT exp < iat; cannot determine expiration.")

issued_utc = datetime.fromtimestamp(iat, tz=timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
expires_utc = datetime.fromtimestamp(exp, tz=timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

print(f"kubeconfig: {kubeconfig}")
print(f"issued:    {issued_utc}")
print(f"expires:   {expires_utc}")
print(f"ttl:       {ttl}s (~{ttl//60}m)")
PY
  exit 0
fi

decode_jwt_payload() {
  local jwt="${1:-}"
  local payload_b64u=""
  payload_b64u="$(printf '%s' "$jwt" | cut -d '.' -f2)"
  if [[ -z "$payload_b64u" || "$payload_b64u" == "$jwt" ]]; then
    return 1
  fi

  local payload_b64=""
  # base64url -> base64
  # '-' must be first in `tr` to avoid being parsed as a range operator.
  payload_b64="$(printf '%s' "$payload_b64u" | tr '-_' '+/')"
  case $(( ${#payload_b64} % 4 )) in
    2) payload_b64="${payload_b64}==" ;;
    3) payload_b64="${payload_b64}=" ;;
    0) ;;
    *) return 1 ;;
  esac

  if printf '%s' "$payload_b64" | base64 -d >/dev/null 2>&1; then
    printf '%s' "$payload_b64" | base64 -d 2>/dev/null
    return 0
  fi
  printf '%s' "$payload_b64" | base64 -D 2>/dev/null
}

payload_json="$(decode_jwt_payload "$token" || true)"
if [[ -z "$payload_json" ]]; then
  echo "Token is not a decodable JWT; cannot determine expiration." >&2
  exit 1
fi

extract_number_field() {
  local json="$1"
  local field="$2"

  if command -v python3 >/dev/null 2>&1; then
    python3 -c 'import json,sys; f=sys.argv[1]; v=json.loads(sys.stdin.read()).get(f); print(int(v)) if isinstance(v,(int,float)) else print("")' "$field" <<<"$json" 2>/dev/null | head -n1
    return 0
  fi

  if command -v jq >/dev/null 2>&1; then
    printf '%s' "$json" | jq -r --arg f "$field" '.[$f] // empty'
    return 0
  fi

  return 1
}

iat="$(extract_number_field "$payload_json" "iat" || true)"
exp="$(extract_number_field "$payload_json" "exp" || true)"

if [[ -z "$iat" || -z "$exp" ]]; then
  echo "JWT payload missing iat/exp; cannot determine expiration." >&2
  exit 1
fi

ttl=$(( exp - iat ))
if (( ttl < 0 )); then
  echo "JWT exp < iat; cannot determine expiration." >&2
  exit 1
fi

expires_utc=""
issued_utc=""
if command -v date >/dev/null 2>&1; then
  issued_utc="$(date -u -d "@$iat" '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || true)"
  expires_utc="$(date -u -d "@$exp" '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || true)"
fi

echo "kubeconfig: $kubeconfig"
echo "issued:    ${issued_utc:-$iat}"
echo "expires:   ${expires_utc:-$exp}"
echo "ttl:       ${ttl}s (~$(( ttl / 60 ))m)"
